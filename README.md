# Описание проекта
Проект представляет собой ETL-пайплайн для геопространственного анализа данных социальной сети с использованием Apache Spark. Система обрабатывает события пользователей, определяет их местоположение, строит пользовательские профили и формирует аналитические витрины.

**Архитектура системы:**
- **Компоненты** - Apache Airflow, Apache Spark, HDFS, YARN;
- **Назначение** - геоаналитика пользовательской активности и генерация рекомендаций.

# Структура данных

**STG слой:**
- `/user/reydanyk/project_7/stg/geo.csv` - справочник городов с координатами;
- `/user/master/data/geo/events` - сырые события пользователей.

**MART слой:**
- `event_sity` - события с геопривязкой к городам;
- `user_sity` - пользовательские профили с геоданными.

**ANALYTICS слой:**
- `zone_analytics` - агрегированная статистика по городам;
- `recommendations` - рекомендации связей между пользователями.

# Структура витрины

**1. Система рекомендации друзей**

Приложение предлагает пользователям написать друг другу, если они:
- Состоят в одном канале (подписки);
- Раньше никогда не переписывались;
- Находятся в одном городе (в радиусе 1 км).

**2. Геоаналитика аудитории**

Для будущей монетизации анализируется:
- Распределение пользователей по количеству сообщений, реакций и подписок;
- Точки с наибольшей регистрацией новых пользователей в Австралии;
- Статистика путешествий и популярные маршруты пользователей.

**3. Профили пользователей**

Определение:
- Актуального местоположения пользователей;
- Домашнего города (места постоянного проживания);
- Истории перемещений между городами.

# Источник данных

**`events` (Parquet) формат:**
- `event` - JSON объект с данными события;
- `event_type` - тип события (message, reaction, subscription, user);
- `lat` - широта (float);
- `lon` - долгота (float);
- `date` - дата события (партиционирование).

**`geo.csv` формат:**
- Разделитель: `;`
- Структура: `city`, `lat`, `lng`
- Особенность: координаты используют запятую как десятичный разделитель

# Процесс выполнения ETL

## Шаг 1: Геопривязка событий
- **Задача**: Привязка событий к ближайшим городам;
- **Алгоритм**: Расчет расстояния по формуле гаверсинуса;
- **Скрипт**: `event_sity.py`.

## Шаг 2: Построение пользовательских профилей
- **Задача**: Создание полных профилей пользователей;
- **Определяет**: актуальный город, домашний город, статистику путешествий;
- **Скрипт**: `user_sity.py`.

## Шаг 3: Аналитика по зонам
- **Задача**: Агрегация статистики активности по городам;
- **Метрики**: сообщения, реакции, подписки по неделям/месяцам;
- **Скрипт**: `zone_analytics.py`.

## Шаг 4: Генерация рекомендаций
- **Задача**: Поиск потенциальных связей между пользователями;
- **Логика**: Пользователи в одних каналах без истории общения;
- **Скрипт**: `recommendations.py`.

# Настройка подключений в Airflow

**Spark Connection:**
- Connection ID: yarn_spark;
- Connection Type: Spark;
- Host: <yarn_resource_manager_host>;
- Extra: {"queue": "default", "deploy-mode": "cluster", "spark-home": "/usr/lib/spark"}.
